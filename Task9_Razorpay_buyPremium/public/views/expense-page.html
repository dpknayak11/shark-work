<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>expenses-page</title>
</head>

<body>
    <div class="container">

        <form onsubmit="formData(event)">
            <label for="amount">Amount:</label>
            <input type="text" id="amount" name="amount" placeholder="Enter Amount">

            <label for="description">Description:</label>
            <input type="text" id="description" name="description" placeholder="Describe expense">

            <label for="category">Select Category:</label>
            <select name="category" id="category">
                <option value="Select"></option>
                <option value="Food">Food</option>
                <option value="Rent">RENT</option>
                <option value="Movie">Movie</option>
                <option value="Shopping">Shopping</option>
                <option value="other">other</option>
            </select>
            <button id="saveBtn" type="submit">Add Expense</button>

            <button type="button" id="rzp-button1">Buy Premium &#11088;</button>
            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <div id="message"></div>
        </form>

    </div>
    <div>
        <h2>User Expenses</h2>
        <ul id="listOfItems"></ul>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.3/axios.min.js" defer></script>

    <script>

        window.addEventListener("DOMContentLoaded", async () => {
            const token = localStorage.getItem('accessToken');
            axios.get("http://localhost:4000/get-expense-data", { headers: { "Authorization": token } })
                .then((details) => {
                    for (var i = 0; i < details.data.length; i++) {
                        showUserOnScreen(details.data[i])
                    }
                })
        });
        async function formData(event) {
            event.preventDefault();
            const amount = event.target.amount.value;
            const description = event.target.description.value;
            const category = event.target.category.value;
            const obj = { amount, description, category };
            try {
                const token = localStorage.getItem('accessToken')
                axios.post("http://localhost:4000/post-expense", obj, { headers: { "Authorization": token } })
                    .then(res => { showUserOnScreen(res.data.expense); })
            } catch (err) { console.log(err) }
        }

        async function showUserOnScreen(obj) {
            const ulTag = document.getElementById("listOfItems");
            const liTag = document.createElement("li");
            liTag.textContent = `${obj.amount} - ${obj.description} - ${obj.category} `;
            // create delete button
            const deleteButton = document.createElement("button");
            deleteButton.textContent = 'delete';

            deleteButton.onclick = (e) => deleteFunction(e, obj.id);

            function deleteFunction(e, obj_id) {
                const deletedObj = { obj_id }
                ulTag.removeChild(liTag);
                const token = localStorage.getItem('accessToken')
                axios.post('http://localhost:4000/delete-expense', deletedObj, { headers: { "Authorization": token } })
            }
            liTag.appendChild(deleteButton);
            ulTag.appendChild(liTag);
        }
    </script>

    <!-- payment method.............. -->

    <script>
        document.getElementById('rzp-button1').onclick = async function (e) {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await axios.get('http://localhost:4000/purchaseMemberShip', { headers: { "Authorization": token } })
                console.log("response:", response);
                var options =
                {
                    "key": response.data.key_id, // Enter the Key ID generated from the Dashboard
                    "order_id": response.data.order.id,// For one time payment
                    "handler": async function (response) {
                        const res = await axios.post('http://localhost:4000/updatetransactionstatus', {
                            order_id: options.order_id,
                            payment_id: response.razorpay_payment_id,
                        }, { headers: { "Authorization": token } })

                        console.log(options)
                        alert('You are a Premium User Now')
                        document.getElementById('Premium').style.visibility = "hidden"
                        document.getElementById('message').innerHTML = "You are a premium user "

                    },
                };
                const rzp1 = new Razorpay(options);
                rzp1.open();
                e.preventDefault();

                rzp1.on("payment.failed", async function (response) {
                    try {
                        const res = await axios.post("http://localhost:4000/updatetransactionstatus",
                            {
                                order_id: options.order_id,
                                payment_failed: true,
                            }, { headers: { Authorization: token } });
                        console.log(res);
                        alert("Something went wrong");
                    } catch (error) { console.log(error) }
                });
            } catch (err) { console.log(err) }
        }
    </script>

</body>

</html>